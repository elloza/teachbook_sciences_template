\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesClass{jupyterBook}[2025/02/11 TeachBook Sciences Template]

% Pass document options defined in config to sphinxmanual.
\DeclareOption*{\PassOptionsToClass{\CurrentOption}{sphinxmanual}}
\ProcessOptions\relax

\RequirePackage{xcolor}
\RequirePackage[utf8]{inputenc}
\RequirePackage{graphicx}
\RequirePackage{amsmath, amssymb, amscd}
\RequirePackage{mathrsfs}
\RequirePackage{tikz}
\usetikzlibrary{arrows}
\usetikzlibrary{calc}
\usetikzlibrary{intersections}
\usetikzlibrary{decorations}
\RequirePackage{pgf}
\RequirePackage{pgfplots}
\RequirePackage{bbm}
% NOTE: hyperref is loaded by sphinx itself, do NOT load it here
\def\sphinxdocclass{report}
\LoadClass{sphinxmanual}
\RequirePackage[strict]{changepage}

% ========================================
% USAL Corporate Colors
% ========================================
\definecolor{usalRed}{HTML}{C8102E}       % Rojo VÃ­tor (Pantone 200C)
\definecolor{usalGrey}{HTML}{58585A}      % Gris corporativo
\definecolor{usalLightGrey}{HTML}{E8E8E8} % Gris claro

% ========================================
% Page Layout
% ========================================
\setlength{\textwidth}{17.5cm}
\setlength{\textheight}{22cm}
\setlength{\fboxsep}{5pt}

% ========================================
% Optional Metadata Commands (defaults to empty)
% ========================================
\newcommand{\BookISBN}{}
\newcommand{\BookDOI}{}
\newcommand{\BookEdition}{}
\newcommand{\BookPublisher}{}
\newcommand{\BookYear}{}
\newcommand{\BookCoverImage}{}
\newcommand{\BookSubtitle}{}
\newcommand{\BookInstitution}{}

% Utility: conditionally render non-empty content
\newcommand{\ifnotempty}[2]{%
  \if\relax\detokenize{#1}\relax\else#2\fi%
}

% Load metadata file if it exists (generated by export_pdf.py)
\InputIfFileExists{bookmetadata.tex}{}{}

% ========================================
% Override Sphinx title page with USAL-branded cover
% ========================================
\renewcommand{\sphinxmaketitle}{%
  \let\sphinxrestorepageanchorsetting\relax
  \ifHy@pageanchor\def\sphinxrestorepageanchorsetting{\Hy@pageanchortrue}\fi
  \hypersetup{pageanchor=false}%
  \begin{titlepage}%
    \begin{tikzpicture}[remember picture, overlay]
      % --- Red background ---
      \fill[usalRed] (current page.south west) rectangle (current page.north east);
      
      % --- White content area ---
      \fill[white, rounded corners=8pt] 
        ([xshift=1.5cm, yshift=1.5cm]current page.south west) 
        rectangle 
        ([xshift=-1.5cm, yshift=-1.5cm]current page.north east);
      
      % --- Logo (top center) ---
      \ifnotempty{\BookCoverImage}{%
        \node[anchor=north] at ([yshift=-2.5cm]current page.north) {%
          \includegraphics[width=8cm]{\BookCoverImage}%
        };
      }
      
      % --- Title ---
      \node[anchor=center, text width=14cm, align=center] at ([yshift=2cm]current page.center) {%
        {\fontsize{28}{34}\selectfont\bfseries\color{usalRed} \@title \par}%
      };
      
      % --- Subtitle ---
      \ifnotempty{\BookSubtitle}{%
        \node[anchor=center, text width=14cm, align=center] at ([yshift=-0.5cm]current page.center) {%
          {\fontsize{16}{20}\selectfont\color{usalGrey} \BookSubtitle \par}%
        };
      }
      
      % --- Author ---
      \node[anchor=center, text width=14cm, align=center] at ([yshift=-2.5cm]current page.center) {%
        {\fontsize{14}{18}\selectfont\color{usalGrey} \@author \par}%
      };
      
      % --- Institution ---
      \ifnotempty{\BookInstitution}{%
        \node[anchor=center, text width=14cm, align=center] at ([yshift=-3.8cm]current page.center) {%
          {\fontsize{12}{15}\selectfont\color{usalGrey}\itshape \BookInstitution \par}%
        };
      }
      
      % --- Bottom red band with metadata ---
      \fill[usalRed] ([yshift=3cm]current page.south west) rectangle ([yshift=4.5cm]current page.south east);
      
      \node[anchor=center, text width=16cm, align=center] at ([yshift=3.75cm]current page.south) {%
        {\color{white}\small%
          \ifnotempty{\BookEdition}{\BookEdition}%
          \ifnotempty{\BookYear}{ \textbullet\ \BookYear}%
          \ifnotempty{\BookISBN}{ \textbullet\ ISBN: \BookISBN}%
          \ifnotempty{\BookDOI}{ \textbullet\ DOI: \BookDOI}%
          \ifnotempty{\BookPublisher}{ \textbullet\ \BookPublisher}%
        }%
      };
      
    \end{tikzpicture}
  \end{titlepage}%
  \setcounter{footnote}{0}%
  \clearpage
  \ifdefined\sphinxbackoftitlepage\sphinxbackoftitlepage\fi
  \if@openright\cleardoublepage\else\clearpage\fi
  \sphinxrestorepageanchorsetting
}

% ========================================
% Math shortcuts
% ========================================
\newcommand{\RR}{\mathbbm R}
\newcommand{\NN}{\mathbbm N}
\newcommand{\PP}{\mathbbm P}
\newcommand{\EE}{\mathbbm E \,}
\newcommand{\XX}{\mathbbm X}
\newcommand{\ZZ}{\mathbbm Z}
\newcommand{\QQ}{\mathbbm Q}
\newcommand{\fF}{\mathcal F}
\newcommand{\dD}{\mathcal D}
\newcommand{\lL}{\mathcal L}
\newcommand{\gG}{\mathcal G}
\newcommand{\hH}{\mathcal H}
\newcommand{\nN}{\mathcal N}
\newcommand{\pP}{\mathcal P}
\newcommand{\BB}{\mathbb B}
\newcommand{\Exp}{\operatorname{Exp}}
\newcommand{\Binomial}{\operatorname{Binomial}}
\newcommand{\Poisson}{\operatorname{Poisson}}
\newcommand{\linop}{\mathcal{L}(\mathbb{B})}
\newcommand{\linopell}{\mathcal{L}(\ell_1)}
\DeclareMathOperator{\trace}{trace}
\DeclareMathOperator{\Var}{Var}
\DeclareMathOperator{\Span}{span}
\DeclareMathOperator{\proj}{proj}
\DeclareMathOperator{\col}{col}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\gt}{>}

% ========================================
% Code styling
% ========================================
\definecolor{codeBlockInputLeftFrame}{RGB}{0,45,74}
\definecolor{CodeBlockInputBorderColor}{RGB}{204,204,204}
\definecolor{CodeBlockInputColor}{RGB}{247,247,247}
\definecolor{CodeBlockOutputBorderColor}{RGB}{247,247,247}
\definecolor{CodeBlockOutputColor}{RGB}{252,252,252}

\newenvironment{leftbarin}
{%
    \def\FrameCommand
    {%
        {\color{codeBlockInputLeftFrame}\vrule width 3pt}%
        \hspace{0pt}%must no space.
        \fboxsep=\FrameSep\colorbox{CodeBlockInputColor}%
    }%
    \MakeFramed{\advance\hsize-\width\@totalleftmargin\z@\linewidth\hsize\@setminipage}%
}
{\endMakeFramed}

% Env which wraps code cell inputs
\newenvironment{sphinxVerbatimInput}
  {\colorlet{VerbatimBorderColor}{CodeBlockInputBorderColor}%
   \colorlet{VerbatimColor}{CodeBlockInputColor}%
   \begin{adjustwidth}{5pt}{}}
  {\end{adjustwidth}}

% Env which wraps code cell outputs
\newenvironment{sphinxVerbatimOutput}
  {\colorlet{VerbatimBorderColor}{CodeBlockOutputBorderColor}%
   \colorlet{VerbatimColor}{CodeBlockOutputColor}%
   \begin{adjustwidth}{20pt}{}}
  {\end{adjustwidth}}
